---
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";
import WikiLayout from "../../layouts/WikiLayout.astro";
import SubcategoryLayout from "../../layouts/SubcategoryLayout.astro";

interface Props {
  entry: CollectionEntry<"wiki">;
}

export async function getStaticPaths() {
  const wikiEntries = await getCollection(
    "wiki",
    ({ data }: CollectionEntry<"wiki">) => {
      return !data.draft;
    },
  );

  console.log("=== ALL WIKI ENTRIES ===");
  wikiEntries.forEach((entry) => {
    console.log(`File: ${entry.slug}`);
    console.log(`  Title: ${entry.data.title}`);
    console.log(`  Category: ${entry.data.category}`);
    console.log(`  Subcategory: ${entry.data.subcategory || "none"}`);
    console.log(`  isIndex: ${entry.data.isIndex}`);
    console.log("---");
  });

  // Filter to include only index files for debugging
  const indexFiles = wikiEntries.filter((entry) => entry.data.isIndex);
  console.log(
    "Index files found:",
    indexFiles.map((e) => ({
      slug: e.slug,
      title: e.data.title,
      category: e.data.category,
      subcategory: e.data.subcategory,
    })),
  );

  return wikiEntries.map((entry: CollectionEntry<"wiki">) => {
    const generatedSlug = entry.slug.split(/[/\\]/).join("/");

    return {
      params: {
        slug: generatedSlug,
      },
      props: { entry },
    };
  });
}

const { entry } = Astro.props as Props;
const { Content, headings } = await entry.render();

// Check if this is a subcategory index page
const isSubcategoryIndex = entry.data.isIndex && entry.data.subcategory;
---

{
  isSubcategoryIndex && entry.data.subcategory ? (
    <SubcategoryLayout
      title={entry.data.title}
      description={entry.data.description}
      tags={entry.data.tags}
      category={entry.data.category}
      subcategory={entry.data.subcategory}
      entry={entry}
    >
      <div class="prose prose-primary dark:prose-invert max-w-none">
        <Content />
      </div>
    </SubcategoryLayout>
  ) : (
    <WikiLayout
      title={entry.data.title}
      description={entry.data.description}
      tags={entry.data.tags}
      category={entry.data.category}
      headings={headings}
      entry={entry}
    >
      <div class="prose prose-primary dark:prose-invert max-w-none">
        <Content />
      </div>
    </WikiLayout>
  )
}
